<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>相機預覽 Demo</title>
    <style>
      /* 簡單樣式（保持輕量） */
      :root {
        color-scheme: light dark;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans,
          Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans CJK TC",
          "PingFang TC", "Microsoft JhengHei", sans-serif;
        line-height: 1.5;
        padding: 16px;
      }
      h1 {
        font-size: 1.25rem;
        margin: 0 0 12px;
      }
      .toolbar {
        display: grid;
        gap: 8px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        align-items: center;
        margin-bottom: 12px;
      }
      label {
        display: grid;
        gap: 4px;
        font-size: 0.9rem;
      }
      select,
      button,
      input[type="checkbox"] {
        font-size: 0.95rem;
        padding: 8px;
      }
      video {
        width: 100%;
        max-width: 960px;
        aspect-ratio: 16 / 9;
        background: #000;
        border-radius: 8px;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }
      .status {
        margin-top: 8px;
        min-height: 1.5em;
        font-size: 0.9rem;
        opacity: 0.85;
      }
    </style>
  </head>
  <body>
    <h1>相機預覽</h1>

    <div class="toolbar">
      <label>
        視訊裝置（相機）
        <select id="cameraSelect"></select>
      </label>

      <label>
        解析度
        <select id="resolutionSelect">
          <!-- 常見解析度選項，會以 ideal 發出需求，實際依裝置支援為準 -->
          <option value="1920x1080">1920 x 1080 (1080p)</option>
          <option value="1280x720" selected>1280 x 720 (720p)</option>
          <option value="640x480">640 x 480 (VGA)</option>
          <option value="3840x2160">3840 x 2160 (4K)</option>
          <option value="default">裝置預設</option>
        </select>
      </label>

      <label class="row" style="padding-top: 18px">
        <input id="useBackCamera" type="checkbox" /> 優先使用後鏡頭（行動裝置）
      </label>

      <div class="row" style="padding-top: 18px">
        <button id="startBtn">開始預覽</button>
        <button id="stopBtn" disabled>停止預覽</button>
      </div>
    </div>

    <video id="preview" playsinline autoplay muted></video>
    <div class="status" id="status"></div>

    <script>
      // 註解：主要流程
      // 1. 要求權限並建立串流 -> 顯示在 <video>
      // 2. 列出可用裝置（必須先取過權限才會有標籤）
      // 3. 支援切換裝置 / 解析度 / 停止串流

      const $ = (sel) => document.querySelector(sel);
      const cameraSelect = $('#cameraSelect');
      const resolutionSelect = $('#resolutionSelect');
      const useBackCamera = $('#useBackCamera');
      const startBtn = $('#startBtn');
      const stopBtn = $('#stopBtn');
      const preview = $('#preview');
      const statusEl = $('#status');

      /** @type {MediaStream | null} */
      let currentStream = null;

      function setStatus(msg, isError = false) {
          statusEl.textContent = msg || '';
          statusEl.style.color = isError ? 'crimson' : 'inherit';
      }

      function stopCurrentStream() {
          if (currentStream) {
              currentStream.getTracks().forEach((t) => t.stop());
              currentStream = null;
          }
          stopBtn.disabled = true;
          startBtn.disabled = false;
      }

      async function listDevices() {
          try {
              const devices = await navigator.mediaDevices.enumerateDevices();
              const videos = devices.filter((d) => d.kind === 'videoinput');

              const selectedId = cameraSelect.value;
              cameraSelect.innerHTML = '';
              for (const d of videos) {
                  const opt = document.createElement('option');
                  opt.value = d.deviceId;
                  opt.textContent = d.label || `Camera ${cameraSelect.length + 1}`;
                  cameraSelect.appendChild(opt);
              }
              // 若原本選擇仍存在，保留選擇
              if ([...cameraSelect.options].some((o) => o.value === selectedId)) {
                  cameraSelect.value = selectedId;
              }

              if (videos.length === 0) {
                  setStatus('找不到視訊裝置，請檢查是否已連接或授權。', true);
              }
          } catch (err) {
              console.error(err);
              setStatus('列出裝置失敗：' + (err && err.message ? err.message : err), true);
          }
      }

      function buildConstraints() {
          // 解析度處理：以 ideal 要求，裝置可能會回傳最接近值
          let width, height;
          const res = resolutionSelect.value;
          if (res && res !== 'default' && res.includes('x')) {
              const [w, h] = res.split('x').map((n) => parseInt(n, 10));
              if (Number.isFinite(w) && Number.isFinite(h)) {
                  width = { ideal: w };
                  height = { ideal: h };
              }
          }

          // 行動裝置：若勾選優先後鏡頭，嘗試使用 facingMode: environment
          const facing = useBackCamera.checked ? { facingMode: { ideal: 'environment' } } : {};

          /** @type {MediaStreamConstraints} */
          const constraints = {
              audio: false,
              video: {
                  ...facing,
                  ...(width && height ? { width, height } : {}),
              },
          };

          // 若使用者選了特定裝置，以 deviceId 覆蓋
          const deviceId = cameraSelect.value;
          if (deviceId) {
              constraints.video = {
                  ...constraints.video,
                  deviceId: { exact: deviceId },
              };
          }
          return constraints;
      }

      async function startPreview() {
          try {
              setStatus('要求相機權限中…');
              stopCurrentStream();
              const constraints = buildConstraints();
              const stream = await navigator.mediaDevices.getUserMedia(constraints);
              currentStream = stream;
              preview.srcObject = stream;
              // iOS/Safari：確保行為正常
              preview.setAttribute('playsinline', 'true');
              preview.muted = true; // 安全自動播放（雖然沒有音訊）
              await preview.play().catch(() => {});

              stopBtn.disabled = false;
              startBtn.disabled = true;
              setStatus('預覽中');

              // 第一次拿到權限後再列出裝置名稱（含標籤）
              await listDevices();
          } catch (err) {
              console.error(err);
              let msg = '開啟相機失敗：';
              if (err && err.name === 'NotAllowedError') msg += '權限被拒絕，請在瀏覽器設定中允許相機權限。';
              else if (err && err.name === 'NotFoundError') msg += '找不到符合條件的相機裝置。';
              else msg += err && err.message ? err.message : String(err);
              setStatus(msg, true);
          }
      }

      async function onDeviceChange() {
          // 使用者切換裝置時，若已在預覽則即時切換
          if (currentStream) {
              await startPreview();
          }
      }

      // 綁定事件
      startBtn.addEventListener('click', startPreview);
      stopBtn.addEventListener('click', () => {
          stopCurrentStream();
          setStatus('已停止');
      });
      cameraSelect.addEventListener('change', onDeviceChange);
      resolutionSelect.addEventListener('change', onDeviceChange);
      useBackCamera.addEventListener('change', onDeviceChange);

    
        
      // 初始化：先嘗試列出裝置（若沒權限，標籤會是空字串），使用者按下「開始預覽」後會再刷新
      if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)) {

          setStatus('此瀏覽器不支援相機 API（MediaDevices.getUserMedia）。請更新或更換瀏覽器。', true);
          startBtn.disabled = true;
      } else {
          listDevices();
          setStatus('請按「開始預覽」以啟用相機');
      }
    </script>
  </body>
</html>
